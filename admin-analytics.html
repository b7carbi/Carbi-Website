<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbi Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #0F172A;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 1.8em;
            color: #0F172A;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select,
        button {
            padding: 8px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: white;
            font-size: 0.95em;
            cursor: pointer;
        }

        button {
            background: #0EA5E9;
            color: white;
            border: none;
            font-weight: 500;
        }

        button:hover {
            background: #0284c7;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #64748B;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 0.9em;
            color: #64748B;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #0F172A;
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 0.85em;
            color: #64748B;
        }

        .positive {
            color: #10B981;
        }

        .negative {
            color: #EF4444;
        }

        .section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #0F172A;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f8fafc;
            color: #64748B;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-top: 1px solid #e2e8f0;
            color: #0F172A;
        }

        tr:hover {
            background: #f8fafc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748B;
        }

        .error {
            background: #FEE2E2;
            color: #991B1B;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .last-updated {
            text-align: center;
            color: #64748B;
            font-size: 0.85em;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9em;
            }

            th,
            td {
                padding: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Carbi Analytics</h1>
            <div class="controls">
                <select id="periodSelect">
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                </select>
                <button onclick="loadDashboard()">Refresh</button>
                <div class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh">Auto-refresh (30s)</label>
                </div>
            </div>
        </header>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Loading analytics...</div>
        <div id="dashboardContent" style="display: none;">

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="card">
                    <div class="card-title">Forms Started</div>
                    <div class="card-value" id="formStarted">-</div>
                    <div class="card-subtitle">Total form starts</div>
                </div>
                <div class="card">
                    <div class="card-title">Forms Completed</div>
                    <div class="card-value" id="formCompleted">-</div>
                    <div class="card-subtitle">Successful submissions</div>
                </div>
                <div class="card">
                    <div class="card-title">Conversion Rate</div>
                    <div class="card-value" id="conversionRate">-</div>
                    <div class="card-subtitle">Completion percentage</div>
                </div>
                <div class="card">
                    <div class="card-title">Cookie Acceptance</div>
                    <div class="card-value" id="cookieAcceptance">-</div>
                    <div class="card-subtitle">Users accepting cookies</div>
                </div>
            </div>

            <!-- Daily Breakdown -->
            <div class="section">
                <h2 class="section-title">Daily Breakdown</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Abandoned</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody id="dailyTable">
                        <tr>
                            <td colspan="5" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Abandonment by Step -->
            <div class="section">
                <h2 class="section-title">Form Abandonment by Step</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Step</th>
                            <th>Abandonments</th>
                        </tr>
                    </thead>
                    <tbody id="abandonmentTable">
                        <tr>
                            <td colspan="2" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Traffic Sources -->
            <div class="section">
                <h2 class="section-title">Traffic Sources</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Form Starts</th>
                        </tr>
                    </thead>
                    <tbody id="trafficTable">
                        <tr>
                            <td colspan="2" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="last-updated">
                Last updated: <span id="lastUpdated">-</span>
            </div>
        </div>
    </div>

    <script>
        // Simple authentication - prompt for password on first load
        let authToken = sessionStorage.getItem('carbi_admin_token');

        if (!authToken) {
            authToken = prompt('Enter admin password:');
            if (!authToken) {
                document.body.innerHTML = '<div class="error" style="margin: 40px;">Access denied</div>';
            } else {
                sessionStorage.setItem('carbi_admin_token', authToken);
            }
        }

        let autoRefreshInterval;

        async function loadDashboard() {
            const period = document.getElementById('periodSelect').value;
            const errorContainer = document.getElementById('errorContainer');
            const loadingContainer = document.getElementById('loadingContainer');
            const dashboardContent = document.getElementById('dashboardContent');

            errorContainer.innerHTML = '';
            loadingContainer.style.display = 'block';
            dashboardContent.style.display = 'none';

            try {
                const response = await fetch(`/api/analytics-dashboard?days=${period}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.status === 401) {
                    sessionStorage.removeItem('carbi_admin_token');
                    location.reload();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch analytics');
                }

                const data = await response.json();

                // Update summary cards
                document.getElementById('formStarted').textContent = data.summary.form_started;
                document.getElementById('formCompleted').textContent = data.summary.form_completed;
                document.getElementById('conversionRate').textContent = data.summary.conversion_rate + '%';
                document.getElementById('cookieAcceptance').textContent = data.summary.cookie_acceptance_rate + '%';

                // Update daily breakdown
                const dailyTable = document.getElementById('dailyTable');
                if (data.daily && data.daily.length > 0) {
                    dailyTable.innerHTML = data.daily.map(day => {
                        const rate = day.started > 0 ? ((day.completed / day.started) * 100).toFixed(1) : 0;
                        return `
                            <tr>
                                <td>${day.date}</td>
                                <td>${day.started}</td>
                                <td>${day.completed}</td>
                                <td>${day.abandoned}</td>
                                <td>${rate}%</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    dailyTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748B;">No data yet</td></tr>';
                }

                // Update abandonment table
                const abandonmentTable = document.getElementById('abandonmentTable');
                if (data.abandonment && data.abandonment.length > 0) {
                    abandonmentTable.innerHTML = data.abandonment.map(item => `
                        <tr>
                            <td>Step ${item.step}</td>
                            <td>${item.count}</td>
                        </tr>
                    `).join('');
                } else {
                    abandonmentTable.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #64748B;">No abandonments</td></tr>';
                }

                // Update traffic sources
                const trafficTable = document.getElementById('trafficTable');
                if (data.traffic && data.traffic.length > 0) {
                    trafficTable.innerHTML = data.traffic.map(item => `
                        <tr>
                            <td>${item.source}</td>
                            <td>${item.count}</td>
                        </tr>
                    `).join('');
                } else {
                    trafficTable.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #64748B;">No traffic data</td></tr>';
                }

                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

                loadingContainer.style.display = 'none';
                dashboardContent.style.display = 'block';

            } catch (error) {
                console.error('Dashboard error:', error);
                errorContainer.innerHTML = `
                    <div class="error">
                        <strong>Error loading analytics:</strong> ${error.message}
                    </div>
                `;
                loadingContainer.style.display = 'none';
            }
        }

        // Auto-refresh logic
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');

            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadDashboard, 30000); // 30 seconds
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('periodSelect').addEventListener('change', loadDashboard);

        // Initial load
        loadDashboard();
        setupAutoRefresh();
    </script>
</body>

</html>