<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Carbi Admin</title>
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <nav class="admin-nav">
        <div class="nav-content">
            <h1 class="nav-logo">Carbi Admin</h1>
            <button onclick="logout()" class="btn-logout">Logout</button>
        </div>
    </nav>

    <main class="admin-main">
        <div class="page-header">
            <h2>Match Requests</h2>
            <div class="stats">
                <span id="totalCount" class="stat-item">Loading...</span>
            </div>
        </div>

        <div id="loadingState" class="loading-state">
            <p>Loading requests...</p>
        </div>

        <div id="errorState" class="error-state" style="display: none;">
            <p id="errorText"></p>
            <button onclick="loadRequests()" class="btn-secondary">Retry</button>
        </div>

        <div id="requestsTable" style="display: none;">
            <div class="table-container">
                <table class="requests-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Budget</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="requestsBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <p>No match requests yet.</p>
        </div>
    </main>

    <script src="admin.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '/admin/login.html';
        }

        // Load requests on page load
        loadRequests();

        async function loadRequests() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const requestsTable = document.getElementById('requestsTable');
            const emptyState = document.getElementById('emptyState');
            const requestsBody = document.getElementById('requestsBody');
            const totalCount = document.getElementById('totalCount');

            // Reset states
            loadingState.style.display = 'block';
            errorState.style.display = 'none';
            requestsTable.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                const data = await apiCall('/api/admin/requests');

                if (!data || !data.requests) {
                    throw new Error('Invalid response from server');
                }

                const requests = data.requests;

                // Update total count
                totalCount.textContent = `${requests.length} total request${requests.length !== 1 ? 's' : ''}`;

                if (requests.length === 0) {
                    loadingState.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                // Populate table
                requestsBody.innerHTML = requests.map(request => `
                    <tr>
                        <td>${formatDate(request.created_at)}</td>
                        <td>
                            <strong>${request.first_name} ${request.last_name}</strong>
                        </td>
                        <td>${request.postcode}</td>
                        <td>${formatCurrency(request.budget_min)} - ${formatCurrency(request.budget_max)}</td>
                        <td>
                            ${request.email ? `<div>${request.email}</div>` : ''}
                            ${request.phone ? `<div>${request.phone}</div>` : ''}
                            <div class="contact-prefs">${request.contact_preferences.join(', ')}</div>
                        </td>
                        <td>
                            <span class="status-badge ${getStatusClass(request.status)}">
                                ${getStatusText(request.status)}
                            </span>
                        </td>
                        <td>
                            <a href="/admin/request.html?id=${request.id}" class="btn-link">View</a>
                        </td>
                    </tr>
                `).join('');

                loadingState.style.display = 'none';
                requestsTable.style.display = 'block';

            } catch (error) {
                console.error('Failed to load requests:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorText').textContent = error.message;
            }
        }
    </script>
</body>

</html>