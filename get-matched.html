<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Matched - Find Your Perfect First Car | Carbi</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png">

    <!-- Cookie Consent -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
    <script>
        window.addEventListener("load", function () {
            window.cookieconsent.initialise({
                palette: {
                    popup: { background: "#0F172A" },
                    button: { background: "#0EA5E9", text: "#ffffff" }
                },
                theme: "classic",
                position: "bottom",
                content: {
                    message: "Cookies help us improve your experience and learn what‚Äôs working in our marketing.",
                    dismiss: "Got it",
                    link: "Privacy Policy",
                    href: "/privacy.html"
                }
            })
        });
    </script>

    <!-- Meta Pixel Code -->
    <script>
        !function (f, b, e, v, n, t, s) {
            if (f.fbq) return; n = f.fbq = function () {
                n.callMethod ?
                    n.callMethod.apply(n, arguments) : n.queue.push(arguments)
            };
            if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
            n.queue = []; t = b.createElement(e); t.async = !0;
            t.src = v; s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s)
        }(window, document, 'script',
            'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1455041752448144');
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=1455041752448144&ev=PageView&noscript=1" /></noscript>
    <!-- End Meta Pixel Code -->

    <!-- Google Analytics & Ads -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1S8XELP34H"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-882133742"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        // Google Analytics
        gtag('config', 'G-1S8XELP34H', {
            'anonymize_ip': true,
            'allow_google_signals': false,
            'allow_ad_personalization_signals': false
        });

        // Google Ads
        gtag('config', 'AW-882133742');
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #0F172A;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            padding: 20px 0;
            background: white;
            border-bottom: 1px solid #E2E8F0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        /* Subtle wink animation */
        @keyframes wink {

            0%,
            95%,
            100% {
                transform: scaleY(1);
            }

            97.5% {
                transform: scaleY(0.1);
            }
        }

        .logo svg circle:first-child {
            transform-origin: center;
            animation: wink 15s ease-in-out 3s infinite;
        }

        .logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        .logo a:hover {
            opacity: 0.8;
        }

        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@600&display=swap');

        .beta-badge {
            background: #FEF3C7;
            color: #92400E;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 1em;
            /* Changed from 0.9em */
            font-weight: 600;
            border: 2px dashed #F59E0B;
            font-family: 'Rubik', sans-serif;
            /* Changed from Caveat */
            transform: rotate(2deg);
        }

        /* Intro Screen */
        .intro-screen {
            padding: 80px 0;
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }

        .intro-screen.hidden {
            display: none;
        }

        .intro-heading {
            font-size: 3em;
            color: #0F172A;
            margin-bottom: 20px;
            font-weight: 700;
            line-height: 1.2;
        }

        .intro-subtext {
            font-size: 1.3em;
            color: #64748B;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .get-started-btn {
            display: inline-block;
            padding: 20px 60px;
            background: #0EA5E9;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(14, 165, 233, 0.3);
        }

        .get-started-btn:hover {
            background: #1E40AF;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.4);
        }

        /* Form Container */
        .form-wrapper {
            padding: 40px 0 80px;
            min-height: calc(100vh - 200px);
        }

        .form-wrapper.hidden {
            display: none;
        }

        /* Steps */
        .step {
            display: none;
            animation: fadeInUp 0.5s ease;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .step.active {
            display: block;
        }

        .step.completed {
            display: block;
            opacity: 0.7;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .step.completed:hover {
            opacity: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-heading {
            font-size: 2em;
            color: #0F172A;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .step-subtitle {
            font-size: 1.1em;
            color: #64748B;
            margin-bottom: 30px;
        }

        /* Buttons Grid */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .option-button {
            padding: 15px 20px;
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #475569;
            font-size: 1em;
            min-height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-button:hover {
            border-color: #0EA5E9;
        }

        .option-button.selected {
            background: #0EA5E9;
            color: white;
            border-color: #0EA5E9;
        }

        /* Category headings for brands */
        .category-heading {
            font-size: 0.9em;
            color: #64748B;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-heading:first-of-type {
            margin-top: 0;
        }

        /* Color buttons */
        .color-button {
            position: relative;
        }

        .color-button::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .color-button[data-color="Black"]::before {
            background: #000;
        }

        .color-button[data-color="White"]::before {
            background: #fff;
            border-color: #cbd5e1;
        }

        .color-button[data-color="Silver"]::before {
            background: #c0c0c0;
        }

        .color-button[data-color="Grey"]::before {
            background: #808080;
        }

        .color-button[data-color="Blue"]::before {
            background: #0EA5E9;
        }

        .color-button[data-color="Red"]::before {
            background: #ef4444;
        }

        .color-button[data-color="Green"]::before {
            background: #22c55e;
        }

        .color-button[data-color="Yellow"]::before {
            background: #fde047;
        }

        .color-button[data-color="Orange"]::before {
            background: #f97316;
        }

        .color-button[data-color="Brown"]::before {
            background: #92400e;
        }

        .color-button[data-color="Purple"]::before {
            background: #a855f7;
        }

        .color-button[data-color="Gold"]::before {
            background: #d97706;
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-label {
            display: block;
            padding: 15px 20px;
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #475569;
            min-height: 54px;
            display: flex;
            align-items: center;
        }

        .radio-option input[type="radio"]:checked+.radio-label {
            background: #0EA5E9;
            color: white;
            border-color: #0EA5E9;
        }

        .radio-label:hover {
            border-color: #0EA5E9;
        }

        /* Budget Inputs */
        .budget-display {
            font-size: 2.5em;
            font-weight: 700;
            color: #0F172A;
            text-align: center;
            margin-bottom: 30px;
        }

        .budget-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 0.9em;
            color: #64748B;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .budget-input {
            padding: 12px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
            font-weight: 600;
        }

        .budget-input:focus {
            outline: none;
            border-color: #0EA5E9;
        }

        /* Dual Handle Range Slider */
        .range-slider-container {
            position: relative;
            height: 50px;
            margin-bottom: 30px;
        }

        .range-slider-track {
            position: absolute;
            top: 20px;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
        }

        .range-slider-range {
            position: absolute;
            top: 20px;
            height: 8px;
            background: #0EA5E9;
            border-radius: 10px;
        }

        .range-slider {
            position: absolute;
            width: 100%;
            height: 8px;
            top: 20px;
            -webkit-appearance: none;
            pointer-events: none;
            background: transparent;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0EA5E9;
            cursor: pointer;
            pointer-events: all;
            position: relative;
            z-index: 2;
            transition: transform 0.2s ease;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0EA5E9;
            cursor: pointer;
            border: none;
            pointer-events: all;
            position: relative;
            z-index: 2;
            transition: transform 0.2s ease;
        }

        .range-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 30px;
        }

        .slider-display {
            font-size: 1.8em;
            font-weight: 700;
            color: #0F172A;
            text-align: center;
            margin-bottom: 20px;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 10px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0EA5E9;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0EA5E9;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        /* Text Inputs */
        .text-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-bottom: 20px;
        }

        .text-input:focus {
            outline: none;
            border-color: #0EA5E9;
        }

        textarea.text-input {
            min-height: 120px;
            resize: vertical;
        }

        .char-count {
            text-align: right;
            font-size: 0.9em;
            color: #64748B;
            margin-top: -15px;
            margin-bottom: 20px;
        }

        /* Location Display */
        .location-display {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            color: #0F172A;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* Geolocation Button */
        .location-button {
            width: 100%;
            padding: 15px 20px;
            background: white;
            border: 2px solid #0EA5E9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #0EA5E9;
            font-size: 1em;
            margin-bottom: 20px;
            min-height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .location-button:hover {
            background: #f0f9ff;
        }

        .location-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Contact Checkboxes */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .checkbox-option {
            position: relative;
        }

        .checkbox-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

        .checkbox-label {
            display: block;
            padding: 15px 20px 15px 50px;
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #475569;
            min-height: 54px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .checkbox-label::before {
            content: '';
            position: absolute;
            left: 15px;
            width: 24px;
            height: 24px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            background: white;
            transition: all 0.3s ease;
        }

        .checkbox-label::after {
            content: '';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg) scale(0);
            width: 8px;
            height: 14px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transition: transform 0.2s ease;
        }

        .checkbox-option input[type="checkbox"]:checked+.checkbox-label {
            border-color: #0EA5E9;
        }

        .checkbox-option input[type="checkbox"]:checked+.checkbox-label::before {
            background: #0EA5E9;
            border-color: #0EA5E9;
        }

        .checkbox-option input[type="checkbox"]:checked+.checkbox-label::after {
            transform: translateY(-50%) rotate(45deg) scale(1);
        }

        .checkbox-label:hover {
            border-color: #0EA5E9;
        }

        /* Primary Action Button */
        .primary-button {
            width: 100%;
            padding: 15px 20px;
            background: #0EA5E9;
            border: 2px solid #0EA5E9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: white;
            font-size: 1.2em;
            min-height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .primary-button:hover:not(:disabled) {
            background: #1E40AF;
            border-color: #1E40AF;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
        }

        .primary-button:disabled {
            background: #cbd5e1;
            border-color: #cbd5e1;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Standalone Don't Mind Button */
        .standalone-button {
            width: 100%;
            padding: 20px;
            background: white;
            border: 3px solid #0EA5E9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #0EA5E9;
            font-size: 1.1em;
            margin-bottom: 30px;
            min-height: 60px;
        }

        .standalone-button:hover {
            background: #0EA5E9;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
        }

        .separator {
            text-align: center;
            color: #64748B;
            margin: 30px 0;
            font-weight: 600;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Validation Errors */
        .error-message {
            color: #ef4444;
            font-size: 0.9em;
            margin-top: -15px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Success Message */
        .success-screen {
            display: none;
            text-align: center;
            padding: 60px 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .success-screen.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #0EA5E9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }

        .success-heading {
            font-size: 2.5em;
            color: #0F172A;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .success-text {
            font-size: 1.2em;
            color: #64748B;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto 30px;
        }

        /* Lead Magnet Download Links */
        .success-screen a[download],
        .success-screen a[target="_blank"] {
            transition: all 0.3s ease;
        }

        .success-screen a[download]:hover,
        .success-screen a[target="_blank"]:hover {
            border-color: #0EA5E9 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        .home-button {
            display: inline-block;
            padding: 15px 40px;
            background: #0EA5E9;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .home-button:hover {
            background: #1E40AF;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .beta-badge {
                font-size: 0.75em;
                padding: 5px 10px;
            }

            .step {
                padding: 30px 20px;
            }

            .intro-heading {
                font-size: 2em;
            }

            .intro-subtext {
                font-size: 1.1em;
            }

            .get-started-btn {
                font-size: 1.1em;
                padding: 18px 40px;
            }

            .step-heading {
                font-size: 1.5em;
            }

            .step-subtitle {
                font-size: 1em;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }

            .budget-display {
                font-size: 1.8em;
            }

            .budget-inputs {
                grid-template-columns: 1fr;
            }

            .success-heading {
                font-size: 1.8em;
            }

            .success-text {
                font-size: 1em;
            }
        }
    </style>
</head>

<body>

    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: none;" id="debugButton">
        <button onclick="localStorage.clear(); location.reload();"
            style="padding: 10px 20px; background: red; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Clear & Reset
        </button>
    </div>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="https://carbi.co" style="display: flex; align-items: center; text-decoration: none;">
                        <svg width="110" height="40" viewBox="0 0 110 40">
                            <circle cx="20" cy="20" r="6" fill="#0EA5E9" />
                            <path d="M 38 14 L 45 20 L 38 26" fill="none" stroke="#1E40AF" stroke-width="3"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <text x="58" y="27" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto"
                                font-size="20" font-weight="600" fill="#0F172A">carbi</text>
                        </svg>
                    </a>
                </div>
                <div class="beta-badge">
                    BETA - LMITED SPOTS
                </div>
            </div>
        </div>
    </header>



    <!-- Form -->
    <div class="form-wrapper active" id="formWrapper">
        <div class="container">
            <form id="matchForm">
                <!-- Step 1: Important Features -->
                <div class="step active" id="step1">
                    <h2 class="step-heading">What's important to you?</h2>
                    <p class="step-subtitle">Select all that apply</p>
                    <div class="button-grid" id="featuresGrid"></div>
                    <div class="error-message" id="error1"></div>
                    <button type="button" class="primary-button" id="next1" disabled>Next</button>
                </div>

                <!-- Step 2: Dealbreakers -->
                <div class="step" id="step2">
                    <h2 class="step-heading">What are your dealbreakers?</h2>
                    <p class="step-subtitle">Pick the features you absolutely need</p>
                    <div class="button-grid" id="dealbreakersGrid"></div>
                    <div class="error-message" id="error2"></div>
                    <button type="button" class="primary-button" id="next2" disabled>Next</button>
                </div>

                <!-- Step 2B: Main Driver -->
                <div class="step" id="step2b">
                    <h2 class="step-heading">Who's going to be the main driver on the insurance?</h2>
                    <p class="step-subtitle">This changes which cars we can recommend</p>

                    <div class="radio-group" id="mainDriverGroup">
                        <div class="radio-option">
                            <input type="radio" name="main_driver" id="driver_young" value="young_driver">
                            <label for="driver_young" class="radio-label">
                                The 17-19 year old
                                <span style="display: block; font-size: 0.9em; color: #64748B; margin-top: 5px;">
                                    Insurance groups 1-10 only
                                </span>
                            </label>
                        </div>

                        <div class="radio-option">
                            <input type="radio" name="main_driver" id="driver_older" value="older_driver">
                            <label for="driver_older" class="radio-label">
                                Someone older (parent/guardian)
                                <span style="display: block; font-size: 0.9em; color: #64748B; margin-top: 5px;">
                                    Insurance groups 1-16 available
                                </span>
                            </label>
                        </div>

                        <div class="radio-option">
                            <input type="radio" name="main_driver" id="driver_unsure" value="not_sure">
                            <label for="driver_unsure" class="radio-label">
                                Not sure yet
                                <span style="display: block; font-size: 0.9em; color: #64748B; margin-top: 5px;">
                                    We'll recommend both options
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="error-message" id="error2b"></div>
                    <button type="button" class="primary-button" id="next2b" disabled>Next</button>
                </div>

                <!-- Step 3: Budget -->
                <div class="step" id="step3">
                    <h2 class="step-heading">What's your budget?</h2>
                    <p class="step-subtitle">Set your price range</p>
                    <div class="budget-display" id="budgetDisplay">¬£6,000 - ¬£8,000</div>

                    <!-- Dual Handle Range Slider -->
                    <div class="range-slider-container">
                        <div class="range-slider-track"></div>
                        <div class="range-slider-range" id="rangeHighlight"></div>
                        <input type="range" id="budgetMinSlider" class="range-slider" min="1000" max="20000"
                            value="6000" step="100">
                        <input type="range" id="budgetMaxSlider" class="range-slider" min="1000" max="20000"
                            value="8000" step="100">
                    </div>

                    <div class="budget-inputs">
                        <div class="input-group">
                            <label class="input-label" for="budgetMin">Minimum</label>
                            <input type="tel" id="budgetMin" class="budget-input" value="¬£6,000">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="budgetMax">Maximum</label>
                            <input type="tel" id="budgetMax" class="budget-input" value="¬£8,000">
                        </div>
                    </div>
                    <div class="error-message" id="error3"></div>
                    <button type="button" class="primary-button" id="next3">Next</button>
                </div>

                <!-- Step 4: Brand Preferences -->
                <div class="step" id="step4">
                    <h2 class="step-heading">Any brand preferences?</h2>
                    <p class="step-subtitle">Choose your preferred brands or skip to find the best car</p>
                    <button type="button" class="standalone-button" id="dontMindBrand">Don't mind - find the best car
                        regardless of brand</button>
                    <div class="separator">Or choose specific brands</div>
                    <div id="brandsContainer"></div>
                    <div class="error-message" id="error4"></div>
                    <button type="button" class="primary-button" id="next4" disabled>Next</button>
                </div>

                <!-- Step 5: Favourite Brand -->
                <div class="step" id="step5">
                    <h2 class="step-heading">Do you have a favourite?</h2>
                    <p class="step-subtitle">Pick your top choice</p>
                    <div class="radio-group" id="favouriteGroup"></div>
                    <div class="error-message" id="error5"></div>
                    <button type="button" class="primary-button" id="next5" disabled>Next</button>
                </div>

                <!-- Step 6: Colour -->
                <div class="step" id="step6">
                    <h2 class="step-heading">What colour car?</h2>
                    <p class="step-subtitle">Select your preferred colours</p>
                    <div class="button-grid" id="coloursGrid"></div>
                    <div id="customColourContainer" style="display: none; margin-top: 20px;">
                        <label class="input-label" for="customColour">What colour?</label>
                        <input type="text" id="customColour" class="text-input"
                            placeholder="e.g., Burgundy, Teal, Bronze">
                    </div>
                    <div class="error-message" id="error6"></div>
                    <button type="button" class="primary-button" id="next6" disabled>Next</button>
                </div>

                <!-- Step 7: Maximum Mileage -->
                <div class="step" id="step7">
                    <h2 class="step-heading">Maximum mileage?</h2>
                    <p class="step-subtitle">Set your mileage limit</p>
                    <div class="slider-container">
                        <div class="slider-display" id="mileageDisplay">50,000 miles</div>
                        <input type="range" id="mileageSlider" class="slider" min="10000" max="150000" value="50000"
                            step="5000">
                    </div>
                    <button type="button" class="primary-button" id="next7">Next</button>
                </div>

                <!-- Step 8: Location and Radius -->
                <div class="step" id="step8">
                    <h2 class="step-heading">How far will you travel?</h2>
                    <p class="step-subtitle">Enter your location and search radius</p>

                    <button type="button" class="location-button" id="useLocationBtn">
                        <span>üìç</span> Use my current location
                    </button>

                    <input type="text" id="postcode" class="text-input" placeholder="Postcode or town">
                    <div class="slider-container">
                        <div class="location-display" id="locationDisplay">Up to 30 miles</div>
                        <input type="range" id="radiusSlider" class="slider" min="10" max="400" value="30" step="5">
                    </div>
                    <div class="error-message" id="error8"></div>
                    <button type="button" class="primary-button" id="next8" disabled>Next</button>
                </div>

                <!-- Step 9: Additional Notes -->
                <div class="step" id="step9">
                    <h2 class="step-heading">Anything else we should know?</h2>
                    <p class="step-subtitle">Optional - help us understand your needs better</p>
                    <textarea id="additionalNotes" class="text-input"
                        placeholder="E.g., must have enough space for sports equipment, needs to be easy to park, prefer automatic..."
                        maxlength="200"></textarea>
                    <div class="char-count"><span id="charCount">0</span>/200</div>
                    <button type="button" class="primary-button" id="next9">Next</button>
                </div>

                <!-- Step 10: Contact Details -->
                <div class="step" id="step10">
                    <h2 class="step-heading">How can we reach you?</h2>
                    <p class="step-subtitle">We'll send your matches within 24 hours</p>
                    <input type="text" id="firstName" class="text-input" placeholder="First Name" required>
                    <input type="text" id="lastName" class="text-input" placeholder="Last Name" required>
                    <input type="email" id="email" class="text-input" placeholder="Email Address">
                    <input type="tel" id="phone" class="text-input" placeholder="Phone Number" required>

                    <p class="input-label" style="margin-bottom: 15px;">How would you like to be contacted? <span
                            style="color: #ef4444;">*</span></p>
                    <div class="checkbox-group" id="contactPreferences">
                        <div class="checkbox-option">
                            <input type="checkbox" id="prefEmail" value="Email">
                            <label for="prefEmail" class="checkbox-label">Email</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="prefText" value="Text">
                            <label for="prefText" class="checkbox-label">Text</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="prefPhone" value="Phone Call">
                            <label for="prefPhone" class="checkbox-label">Phone Call</label>
                        </div>
                    </div>
                    <div class="error-message" id="error10"></div>
                    <button type="submit" class="primary-button" id="submitBtn" disabled>Find My Car</button>
                </div>
            </form>

            <!-- Success Screen -->
            <div class="success-screen" id="successScreen">
                <div class="success-icon">
                    <svg width="50" height="50" viewBox="0 0 50 50">
                        <path d="M10 25 L20 35 L40 15" stroke="white" stroke-width="4" fill="none"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h2 class="success-heading">Thanks!</h2>
                <p class="success-text">We're looking for your perfect match. <br> You'll hear from us within 24 hours.
                </p>

                <!-- Lead Magnets Section -->
                <div style="margin: 40px 0; padding: 30px; background: #f8fafc; border-radius: 12px;">
                    <h3 style="font-size: 1.3em; color: #0F172A; margin-bottom: 20px; font-weight: 600;">
                        Car Buying Toolkit
                    </h3>
                    <p style="color: #64748B; margin-bottom: 25px; font-size: 1em;">
                        Here are some spreadsheets and a checklist to help you get behind the wheel.
                    </p>

                    <a href="/downloads/budget-calculator/download.html"
                        style="display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: white; border: 2px solid #E2E8F0; border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                        <img src="/images/calculator-icon.png" alt=""
                            style="width: 48px; height: 48px; flex-shrink: 0;">
                        <div style="text-align: left; flex: 1;">
                            <div style="color: #0F172A; font-weight: 600; font-size: 1em;">Budget Calculator</div>
                            <div style="color: #64748B; font-size: 0.9em;">Work out your realistic first year costs
                            </div>
                        </div>
                    </a>


                    <a href="/downloads/quote-comparison/download.html"
                        style="display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: white; border: 2px solid #E2E8F0; border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                        <img src="/images/Insurance-comparison-icon.png" alt=""
                            style="width: 48px; height: 48px; flex-shrink: 0;">
                        <div style="text-align: left; flex: 1;">
                            <div style="color: #0F172A; font-weight: 600; font-size: 1em;">Insurance Quote
                                Comparison</div>
                            <div style="color: #64748B; font-size: 0.9em;">Compare quotes side by side</div>
                        </div>
                    </a>


                    <a href="/downloads/car-viewing-checklist/checklist.html"
                        style="display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: white; border: 2px solid #E2E8F0; border-radius: 10px; text-decoration: none; transition: all 0.3s ease;">
                        <img src="/images/viewing-checklist-icon.png" alt=""
                            style="width: 48px; height: 48px; flex-shrink: 0;">
                        <div style="text-align: left; flex: 1;">
                            <div style="color: #0F172A; font-weight: 600; font-size: 1em;">Car Viewing Checklist</div>
                            <div style="color: #64748B; font-size: 0.9em;">Don't buy a lemon</div>
                        </div>
                    </a>

                </div>
            </div>


        </div>
    </div>
    </div>

    <script>
        // Form data structure
        const formData = {
            important_features: [],
            dealbreakers: [],
            main_driver_type: null,
            budget_min: 6000,
            budget_max: 8000,
            brand_preference: null,
            selected_brands: [],
            favourite_brand: null,
            preferred_colours: [],
            custom_colour: '',
            max_mileage: null,
            search_radius: 30,
            postcode: '',
            location_coords: null,
            additional_notes: null,
            first_name: '',
            last_name: '',
            email: '',
            phone: '',
            contact_preferences: []
        };

        // Feature options
        const features = [
            'Safety', 'Size', 'Colour', 'Cost', 'Performance', 'Engine Size',
            'Fuel Efficiency', 'Insurance Cost', 'Make and Model', 'Location',
            'Interior Features', 'Bluetooth', 'Heated Seats', 'Leather Seats',
            'Low Mileage', 'Reliability', 'Ambient Lighting', 'Practicality',
            'Full Service History', 'Low Emission Zone Friendly', 'Number of Doors'
        ];

        // Brand options by category
        const brands = {
            'Premium': ['Audi', 'BMW', 'Mercedes', 'MINI', 'Volvo'],
            'Established': ['Ford', 'Honda', 'Mazda', 'SEAT', 'Skoda', 'Smart', 'Toyota', 'Volkswagen'],
            'Regular': ['Citroen', 'Dacia', 'DS', 'Fiat', 'Hyundai', 'Kia', 'MG', 'Mitsubishi', 'Nissan', 'Peugeot', 'Renault', 'Suzuki', 'Vauxhall']
        };

        // Colour options
        const colours = [
            'Black', 'White', 'Silver', 'Grey', 'Blue', 'Red', 'Green',
            'Yellow', 'Orange', 'Brown', 'Purple', 'Gold', 'Other'
        ];

        let currentStep = 1;
        const totalSteps = 10;

        // Initialize form
        document.addEventListener('DOMContentLoaded', function () {
            loadFromLocalStorage();

            initializeStep1();
            initializeStep2b();
            initializeStep3();
            initializeStep4();
            initializeStep7();
            initializeStep8();
            initializeStep9();
            initializeStep10Validation();
            setupNextButtonHandlers();
            restoreFormState();
            // Show debug button if ?debug=true in URL
            const debugBtn = document.getElementById('debugButton');
            if (debugBtn) {
                if (window.location.search.includes('debug=true')) {
                    debugBtn.style.display = 'block';
                }
            }
        });





        // Helper: Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Helper: Format currency
        function formatCurrency(value) {
            // Remove non-digits
            const num = parseInt(value.toString().replace(/[^\d]/g, ''));
            if (isNaN(num)) return '¬£0';
            return '¬£' + formatNumber(num);
        }

        // Helper: Parse currency to number
        function parseCurrency(str) {
            const num = parseInt(str.replace(/[^\d]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        // Step 1: Important Features
        function initializeStep1() {
            const grid = document.getElementById('featuresGrid');
            features.forEach(feature => {
                const button = createOptionButton(feature);
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    button.classList.toggle('selected');
                    updateFeaturesList();
                    validateStep1();
                });
                grid.appendChild(button);
            });
        }

        function createOptionButton(text) {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'option-button';
            button.textContent = text;
            button.setAttribute('data-value', text);
            return button;
        }

        function updateFeaturesList() {
            const selected = document.querySelectorAll('#featuresGrid .option-button.selected');
            formData.important_features = Array.from(selected).map(btn => btn.dataset.value);
            saveToLocalStorage();
        }

        function validateStep1() {
            const nextBtn = document.getElementById('next1');
            const errorMsg = document.getElementById('error1');

            if (formData.important_features.length > 0) {
                errorMsg.textContent = '';
                nextBtn.disabled = false;
            } else {
                nextBtn.disabled = true;
            }
        }

        // Step 2: Dealbreakers
        function initializeStep2() {
            const grid = document.getElementById('dealbreakersGrid');
            grid.innerHTML = '';

            formData.important_features.forEach(feature => {
                const button = createOptionButton(feature);
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    button.classList.toggle('selected');
                    updateDealbreakers();
                    validateStep2();
                });
                grid.appendChild(button);
            });
        }

        function updateDealbreakers() {
            const selected = document.querySelectorAll('#dealbreakersGrid .option-button.selected');
            formData.dealbreakers = Array.from(selected).map(btn => btn.dataset.value);
            saveToLocalStorage();
        }

        function validateStep2() {
            const nextBtn = document.getElementById('next2');
            nextBtn.disabled = formData.dealbreakers.length === 0;
        }

        function initializeStep2b() {
            const radios = document.querySelectorAll('input[name="main_driver"]');

            radios.forEach(radio => {
                radio.addEventListener('change', () => {
                    formData.main_driver_type = radio.value;
                    saveToLocalStorage();
                    document.getElementById('next2b').disabled = false;
                });
            });
        }

        function validateStep2b() {
            const nextBtn = document.getElementById('next2b');
            nextBtn.disabled = !formData.main_driver_type;
        }


        // Step 3: Budget with Dual Handle Slider
        function initializeStep3() {
            const minSlider = document.getElementById('budgetMinSlider');
            const maxSlider = document.getElementById('budgetMaxSlider');
            const minInput = document.getElementById('budgetMin');
            const maxInput = document.getElementById('budgetMax');
            const display = document.getElementById('budgetDisplay');
            const rangeHighlight = document.getElementById('rangeHighlight');

            function updateRangeHighlight() {
                const min = parseInt(minSlider.value);
                const max = parseInt(maxSlider.value);
                const totalRange = 20000 - 1000;
                const minPercent = ((min - 1000) / totalRange) * 100;
                const maxPercent = ((max - 1000) / totalRange) * 100;

                rangeHighlight.style.left = minPercent + '%';
                rangeHighlight.style.width = (maxPercent - minPercent) + '%';
            }

            function updateBudgetDisplay() {
                const min = parseInt(minSlider.value);
                const max = parseInt(maxSlider.value);
                display.textContent = `${formatCurrency(min)} - ${formatCurrency(max)}`;
                minInput.value = formatCurrency(min);
                maxInput.value = formatCurrency(max);
                updateRangeHighlight();
            }

            minSlider.addEventListener('input', () => {
                let min = parseInt(minSlider.value);
                let max = parseInt(maxSlider.value);

                if (min >= max - 100) {
                    min = max - 100;
                    minSlider.value = min;
                }

                formData.budget_min = min;
                updateBudgetDisplay();
                saveToLocalStorage();
            });

            maxSlider.addEventListener('input', () => {
                let min = parseInt(minSlider.value);
                let max = parseInt(maxSlider.value);

                if (max <= min + 100) {
                    max = min + 100;
                    maxSlider.value = max;
                }

                formData.budget_max = max;
                updateBudgetDisplay();
                saveToLocalStorage();
            });

            // Text input handling with formatting
            minInput.addEventListener('blur', () => {
                let value = parseCurrency(minInput.value);
                value = Math.max(1000, Math.min(19900, value));

                if (value >= parseInt(maxSlider.value)) {
                    value = parseInt(maxSlider.value) - 100;
                }

                minSlider.value = value;
                formData.budget_min = value;
                updateBudgetDisplay();
                saveToLocalStorage();
            });

            maxInput.addEventListener('blur', () => {
                let value = parseCurrency(maxInput.value);
                value = Math.max(1100, Math.min(20000, value));

                if (value <= parseInt(minSlider.value)) {
                    value = parseInt(minSlider.value) + 100;
                }

                maxSlider.value = value;
                formData.budget_max = value;
                updateBudgetDisplay();
                saveToLocalStorage();
            });

            updateRangeHighlight();
        }

        // Step 4: Brand Preferences
        function initializeStep4() {
            const container = document.getElementById('brandsContainer');

            Object.keys(brands).forEach(category => {
                const heading = document.createElement('div');
                heading.className = 'category-heading';
                heading.textContent = category;
                container.appendChild(heading);

                const grid = document.createElement('div');
                grid.className = 'button-grid';

                brands[category].forEach(brand => {
                    const button = createOptionButton(brand);
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.getElementById('dontMindBrand').style.background = 'white';
                        document.getElementById('dontMindBrand').style.color = '#0EA5E9';
                        formData.brand_preference = 'specific';

                        button.classList.toggle('selected');
                        updateBrands();
                        validateStep4();
                    });
                    grid.appendChild(button);
                });

                container.appendChild(grid);
            });
        }

        function updateBrands() {
            const selected = document.querySelectorAll('#brandsContainer .option-button.selected');
            formData.selected_brands = Array.from(selected).map(btn => btn.dataset.value);
            saveToLocalStorage();
        }

        function validateStep4() {
            const nextBtn = document.getElementById('next4');
            nextBtn.disabled = formData.selected_brands.length === 0;
        }

        // Step 5: Favourite Brand (radio selection auto-advances)
        function initializeStep5() {
            const group = document.getElementById('favouriteGroup');
            group.innerHTML = '';

            formData.selected_brands.forEach(brand => {
                const option = document.createElement('div');
                option.className = 'radio-option';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'favourite_brand';
                input.id = `fav_${brand}`;
                input.value = brand;

                const label = document.createElement('label');
                label.className = 'radio-label';
                label.htmlFor = `fav_${brand}`;
                label.textContent = brand;

                input.addEventListener('change', () => {
                    formData.favourite_brand = brand;
                    saveToLocalStorage();
                    document.getElementById('next5').disabled = false; // Enable Next button


                });

                option.appendChild(input);
                option.appendChild(label);
                group.appendChild(option);
            });

            // Add "no favourite" option
            const noFavOption = document.createElement('div');
            noFavOption.className = 'radio-option';

            const noFavInput = document.createElement('input');
            noFavInput.type = 'radio';
            noFavInput.name = 'favourite_brand';
            noFavInput.id = 'no_favourite';
            noFavInput.value = 'none';

            const noFavLabel = document.createElement('label');
            noFavLabel.className = 'radio-label';
            noFavLabel.htmlFor = 'no_favourite';
            noFavLabel.textContent = "I don't have a favourite";

            noFavInput.addEventListener('change', () => {
                formData.favourite_brand = null;
                saveToLocalStorage();
                document.getElementById('next5').disabled = false;


            });

            noFavOption.appendChild(noFavInput);
            noFavOption.appendChild(noFavLabel);
            group.appendChild(noFavOption);
        }

        // Step 6: Colour
        function initializeStep6() {
            // Only initialize if Colour was selected as important
            if (!formData.important_features.includes('Colour')) {
                return;
            }
            const grid = document.getElementById('coloursGrid');
            const customColourContainer = document.getElementById('customColourContainer');
            const customColourInput = document.getElementById('customColour');
            grid.innerHTML = '';

            colours.forEach(colour => {
                const button = createOptionButton(colour);
                button.classList.add('color-button');
                button.setAttribute('data-color', colour);
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    button.classList.toggle('selected');

                    // Show/hide custom colour input if "Other" is selected
                    if (colour === 'Other') {
                        if (button.classList.contains('selected')) {
                            customColourContainer.style.display = 'block';
                            customColourInput.required = true;
                        } else {
                            customColourContainer.style.display = 'none';
                            customColourInput.required = false;
                            customColourInput.value = '';
                            formData.custom_colour = '';
                        }
                    }

                    updateColours();
                    validateStep6();
                });
                grid.appendChild(button);
            });

            // Handle custom colour input
            customColourInput.addEventListener('input', () => {
                formData.custom_colour = customColourInput.value.trim();
                updateColours();
                validateStep6();
            });
        }

        function updateColours() {
            const selected = document.querySelectorAll('#coloursGrid .option-button.selected');
            formData.preferred_colours = Array.from(selected).map(btn => btn.dataset.value);
            saveToLocalStorage();
        }

        function validateStep6() {
            const nextBtn = document.getElementById('next6');
            const otherSelected = formData.preferred_colours.includes('Other');

            // Check if we have valid colour selection
            let isValid = formData.preferred_colours.length > 0;

            // If "Other" is selected, require custom input
            if (otherSelected) {
                isValid = isValid && formData.custom_colour.length > 0;
            }

            nextBtn.disabled = !isValid;
        }

        // Step 7: Maximum Mileage
        function initializeStep7() {
            const slider = document.getElementById('mileageSlider');
            const display = document.getElementById('mileageDisplay');

            slider.addEventListener('input', () => {
                const value = parseInt(slider.value);
                display.textContent = `${formatNumber(value)} miles`;
                formData.max_mileage = value;
                saveToLocalStorage();
            });
        }

        // Step 8: Location and Radius
        function initializeStep8() {
            const postcodeInput = document.getElementById('postcode');
            const slider = document.getElementById('radiusSlider');
            const display = document.getElementById('locationDisplay');
            const useLocationBtn = document.getElementById('useLocationBtn');

            function updateLocationDisplay() {
                const postcode = postcodeInput.value.trim();
                const radius = slider.value;

                if (postcode) {
                    display.textContent = `Up to ${radius} miles from ${postcode}`;
                } else {
                    display.textContent = `Up to ${radius} miles`;
                }
            }

            postcodeInput.addEventListener('input', () => {
                formData.postcode = postcodeInput.value.trim();
                saveToLocalStorage();
                updateLocationDisplay();
                validateStep8();
            });

            slider.addEventListener('input', () => {
                formData.search_radius = parseInt(slider.value);
                saveToLocalStorage();
                updateLocationDisplay();
            });

            // Geolocation
            useLocationBtn.addEventListener('click', async () => {
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser');
                    return;
                }

                useLocationBtn.disabled = true;
                useLocationBtn.innerHTML = '<span>‚è≥</span> Getting location...';

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Store coordinates
                        formData.location_coords = { lat, lon };

                        // Try to get human-readable address via reverse geocoding
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,
                                {
                                    headers: {
                                        'User-Agent': 'Carbi-Website/1.0 (car matching service)'
                                    }
                                }
                            );

                            if (response.ok) {
                                const data = await response.json();

                                // Try to extract postcode, fallback to city/town
                                let locationText = '';
                                if (data.address) {
                                    if (data.address.postcode) {
                                        locationText = data.address.postcode;
                                    } else if (data.address.city) {
                                        locationText = data.address.city;
                                    } else if (data.address.town) {
                                        locationText = data.address.town;
                                    } else if (data.address.village) {
                                        locationText = data.address.village;
                                    }
                                }

                                // Fallback to coordinates if no readable location found
                                if (!locationText) {
                                    locationText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                                }

                                formData.postcode = locationText;
                                postcodeInput.value = locationText;
                            } else {
                                // API failed, use coordinates
                                formData.postcode = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                                postcodeInput.value = formData.postcode;
                            }
                        } catch (error) {
                            console.error('Reverse geocoding error:', error);
                            // Fallback to coordinates
                            formData.postcode = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                            postcodeInput.value = formData.postcode;
                        }

                        saveToLocalStorage();
                        updateLocationDisplay();
                        validateStep8();

                        useLocationBtn.innerHTML = '<span>‚úì</span> Location found';
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Could not get your location. Please enter it manually.');
                        useLocationBtn.disabled = false;
                        useLocationBtn.innerHTML = '<span>üìç</span> Use my current location';
                    }
                );
            });
        }

        function validateStep8() {
            const nextBtn = document.getElementById('next8');
            const postcode = document.getElementById('postcode').value.trim();
            nextBtn.disabled = postcode.length < 3;
        }

        // Step 9: Additional Notes
        function initializeStep9() {
            const textarea = document.getElementById('additionalNotes');
            const charCount = document.getElementById('charCount');

            textarea.addEventListener('input', () => {
                const length = textarea.value.length;
                charCount.textContent = length;
                formData.additional_notes = textarea.value.trim() || null;
                saveToLocalStorage();
            });
        }

        // Step 10: Contact Details - Validation
        function initializeStep10Validation() {
            ['firstName', 'lastName', 'email', 'phone'].forEach(id => {
                document.getElementById(id).addEventListener('input', validateStep10);
            });

            // Only validate email on blur (when they leave the field)
            document.getElementById('email').addEventListener('blur', validateStep10);

            ['prefEmail', 'prefText', 'prefPhone'].forEach(id => {
                document.getElementById(id).addEventListener('change', validateStep10);
            });
        }

        function validateStep10() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const checkboxes = document.querySelectorAll('#contactPreferences input[type="checkbox"]:checked');
            const submitBtn = document.getElementById('submitBtn');
            const errorMsg = document.getElementById('error10');

            // Phone is always required, email only required if selected as preference
            const emailSelected = document.getElementById('prefEmail').checked;

            if (!firstName || !lastName || !phone) {
                submitBtn.disabled = true;
                return false;
            }

            if (emailSelected && !email) {
                errorMsg.textContent = 'Email address needed (you selected it as contact preference)';
                submitBtn.disabled = true;
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMsg.textContent = 'Please enter a valid email address';
                submitBtn.disabled = true;
                return false;
            }

            const phoneRegex = /^[\d\s\+\-\(\)]{10,}$/;
            if (!phoneRegex.test(phone)) {
                errorMsg.textContent = 'Please enter a valid phone number';
                submitBtn.disabled = true;
                return false;
            }



            errorMsg.textContent = '';
            submitBtn.disabled = false;
            return true;
        }

        // Setup all Next button click handlers
        function setupNextButtonHandlers() {
            // Step 1 Next button
            document.getElementById('next1').addEventListener('click', (e) => {
                e.stopPropagation();
                if (formData.important_features.length >= 2) {
                    initializeStep2();
                    goToStep(2);
                } else {
                    goToStep(3);
                }
            });

            // Step 2 Next button
            document.getElementById('next2').addEventListener('click', (e) => {
                e.stopPropagation();
                goToStep('2b'); // Or renumber to Step 3
            });

            // Step 2B Next button
            document.getElementById('next2b').addEventListener('click', (e) => {
                e.stopPropagation();
                goToStep(3);
            });

            // Step 3 Next button
            document.getElementById('next3').addEventListener('click', (e) => {
                e.stopPropagation();
                goToStep(4);
            });

            // Step 4 Next button
            document.getElementById('next4').addEventListener('click', (e) => {
                e.stopPropagation();
                if (formData.selected_brands.length < 2) {
                    if (formData.important_features.includes('Colour')) {
                        initializeStep6();
                        goToStep(6);
                    } else if (formData.important_features.includes('Low Mileage')) {
                        goToStep(7);
                    } else {
                        goToStep(8);
                    }
                } else {
                    initializeStep5();
                    goToStep(5);
                }
            });

            // Step 4 "Don't mind" button
            document.getElementById('dontMindBrand').addEventListener('click', (e) => {
                e.stopPropagation();
                formData.brand_preference = 'dont_mind';
                formData.selected_brands = [];
                saveToLocalStorage();
                goToStep(8);
            });

            // Step 5 Next button
            document.getElementById('next5').addEventListener('click', (e) => {
                e.stopPropagation();
                if (formData.important_features.includes('Colour')) {
                    initializeStep6();
                    goToStep(6);
                } else if (formData.important_features.includes('Low Mileage')) {
                    goToStep(7);
                } else {
                    goToStep(8);
                }
            });


            // Step 6 Next button
            document.getElementById('next6').addEventListener('click', (e) => {
                e.stopPropagation();
                if (formData.important_features.includes('Low Mileage')) {
                    goToStep(7);
                } else {
                    goToStep(8);
                }
            });

            // Step 7 Next button
            document.getElementById('next7').addEventListener('click', (e) => {
                e.stopPropagation();
                goToStep(8);
            });

            // Step 8 Next button
            document.getElementById('next8').addEventListener('click', (e) => {
                e.stopPropagation();
                goToStep(9);
            });

            // Step 9 Next button
            document.getElementById('next9').addEventListener('click', (e) => {
                e.stopPropagation();
                goToStep(10);
            });

            // Allow clicking on completed steps to go back
            for (let i = 1; i <= totalSteps; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    stepEl.addEventListener('click', function () {
                        if (this.classList.contains('completed')) {
                            goToStep(i);
                        }
                    });
                }
            }
        }

        // Form submission
        document.getElementById('matchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check contact preferences before submission
            const checkboxes = document.querySelectorAll('#contactPreferences input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                const errorMsg = document.getElementById('error10');
                errorMsg.textContent = 'Please select at least one contact preference';
                return;
            }

            formData.first_name = document.getElementById('firstName').value.trim();
            formData.last_name = document.getElementById('lastName').value.trim();
            formData.email = document.getElementById('email').value.trim();
            formData.phone = document.getElementById('phone').value.trim();

            const selectedPrefs = document.querySelectorAll('#contactPreferences input[type="checkbox"]:checked');
            formData.contact_preferences = Array.from(selectedPrefs).map(cb => cb.value);

            if (!validateStep10()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            try {
                // Submit to API
                const response = await fetch('/api/submit-match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Submission failed');
                }

                // Success - track conversions
                if (typeof fbq !== 'undefined') {
                    fbq('track', 'Lead');
                }
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'conversion', { 'send_to': 'AW-882133742/XXXXX' });
                }

                // Log for debugging
                console.log('Match request submitted:', result.id);

                // Clear form data and show success
                localStorage.removeItem('carbi_match_form');
                document.getElementById('matchForm').style.display = 'none';
                document.getElementById('successScreen').classList.add('active');

                // Scroll to top to show success message
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });

            } catch (error) {
                console.error('Submission error:', error);

                // Reset button and show error
                submitBtn.textContent = 'Find My Car';
                submitBtn.disabled = false;

                // Show error message
                const errorMsg = document.getElementById('error10');
                errorMsg.textContent = 'Failed to submit. Please try again or contact us directly.';

                alert('There was a problem submitting your request. Please try again.');
            }
        });

        // Navigation - go to specific step
        function goToStep(stepNumber) {
            // Helper function to check if a step should be visible
            function shouldShowStep(stepNum) {
                if (stepNum === 1) return true; // Always show Step 1
                if (stepNum === 2) return formData.important_features.length >= 2; // Show if 2+ features
                if (stepNum === 3) return true; // Always show budget
                if (stepNum === 4) return true; // Always show brands
                if (stepNum === 5) return formData.selected_brands.length >= 2; // Show if 2+ brands
                if (stepNum === 6) return formData.important_features.includes('Colour'); // Only if Colour selected
                if (stepNum === 7) return formData.important_features.includes('Low Mileage'); // Only if Low Mileage selected
                if (stepNum >= 8) return true; // Always show Steps 8, 9, 10
                return false;
            }

            // Mark visible steps before target as completed
            for (let i = 1; i < stepNumber; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    if (shouldShowStep(i)) {
                        stepEl.classList.remove('active');
                        stepEl.classList.add('completed');
                    } else {
                        // Hide steps that shouldn't be visible
                        stepEl.classList.remove('completed', 'active');
                    }
                }
            }

            // Hide all steps after target
            for (let i = stepNumber + 1; i <= totalSteps; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    stepEl.classList.remove('completed', 'active');
                }
            }

            // Activate target step
            const targetStepEl = document.getElementById(`step${stepNumber}`);
            if (targetStepEl) {
                targetStepEl.classList.remove('completed');
                targetStepEl.classList.add('active');
            }

            currentStep = stepNumber;

            // Scroll to step with padding above
            if (targetStepEl) {
                setTimeout(() => {
                    window.scrollTo({
                        top: targetStepEl.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        // Local Storage
        function saveToLocalStorage() {
            localStorage.setItem('carbi_match_form', JSON.stringify(formData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('carbi_match_form');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(formData, data);
            }
        }

        // Restore form state from loaded data
        function restoreFormState() {
            // Step 1: Restore selected features
            formData.important_features.forEach(feature => {
                const button = document.querySelector(`#featuresGrid .option-button[data-value="${feature}"]`);
                if (button) button.classList.add('selected');
            });
            validateStep1();

            // Step 2: Restore dealbreakers (if step was initialized)
            if (formData.dealbreakers.length > 0 && formData.important_features.length >= 2) {
                initializeStep2();
                formData.dealbreakers.forEach(dealbreaker => {
                    const button = document.querySelector(`#dealbreakersGrid .option-button[data-value="${dealbreaker}"]`);
                    if (button) button.classList.add('selected');
                });
                validateStep2();
            }

            //Step 2b: Restore main driver values
            if (formData.main_driver_type) {
                const radio = document.querySelector(`input[name="main_driver"][value="${formData.main_driver_type}"]`);
                if (radio) {
                    radio.checked = true;
                    document.getElementById('next2b').disabled = false;
                }
            }

            // Step 3: Restore budget values
            if (formData.budget_min || formData.budget_max) {
                const minSlider = document.getElementById('budgetMinSlider');
                const maxSlider = document.getElementById('budgetMaxSlider');
                const minInput = document.getElementById('budgetMin');
                const maxInput = document.getElementById('budgetMax');
                const display = document.getElementById('budgetDisplay');

                if (formData.budget_min) {
                    minSlider.value = formData.budget_min;
                    minInput.value = formatCurrency(formData.budget_min);
                }
                if (formData.budget_max) {
                    maxSlider.value = formData.budget_max;
                    maxInput.value = formatCurrency(formData.budget_max);
                }
                display.textContent = `${formatCurrency(formData.budget_min)} - ${formatCurrency(formData.budget_max)}`;

                // Update range highlight
                const rangeHighlight = document.getElementById('rangeHighlight');
                const min = parseInt(minSlider.value);
                const max = parseInt(maxSlider.value);
                const totalRange = 20000 - 1000;
                const minPercent = ((min - 1000) / totalRange) * 100;
                const maxPercent = ((max - 1000) / totalRange) * 100;
                rangeHighlight.style.left = minPercent + '%';
                rangeHighlight.style.width = (maxPercent - minPercent) + '%';
            }

            // Step 4: Restore selected brands
            formData.selected_brands.forEach(brand => {
                const button = document.querySelector(`#brandsContainer .option-button[data-value="${brand}"]`);
                if (button) button.classList.add('selected');
            });
            validateStep4();

            // Step 6: Restore selected colors (if step was initialized)
            if (formData.preferred_colours.length > 0 && formData.important_features.includes('Colour')) {
                initializeStep6();
                formData.preferred_colours.forEach(colour => {
                    const button = document.querySelector(`#coloursGrid .option-button[data-value="${colour}"]`);
                    if (button) button.classList.add('selected');
                });

                // Restore custom colour if "Other" was selected
                if (formData.preferred_colours.includes('Other') && formData.custom_colour) {
                    const customColourContainer = document.getElementById('customColourContainer');
                    const customColourInput = document.getElementById('customColour');
                    customColourContainer.style.display = 'block';
                    customColourInput.required = true;
                    customColourInput.value = formData.custom_colour;
                }
                validateStep6();
            }

            // Step 7: Restore mileage
            if (formData.max_mileage) {
                const slider = document.getElementById('mileageSlider');
                const display = document.getElementById('mileageDisplay');
                slider.value = formData.max_mileage;
                display.textContent = `${formatNumber(formData.max_mileage)} miles`;
            }

            // Step 8: Restore postcode and radius
            if (formData.postcode) {
                document.getElementById('postcode').value = formData.postcode;
            }
            if (formData.search_radius) {
                const slider = document.getElementById('radiusSlider');
                slider.value = formData.search_radius;
                const display = document.getElementById('locationDisplay');
                if (formData.postcode) {
                    display.textContent = `Up to ${formData.search_radius} miles from ${formData.postcode}`;
                } else {
                    display.textContent = `Up to ${formData.search_radius} miles`;
                }
            }
            validateStep8();

            // Step 9: Restore notes
            if (formData.additional_notes) {
                const textarea = document.getElementById('additionalNotes');
                const charCount = document.getElementById('charCount');
                textarea.value = formData.additional_notes;
                charCount.textContent = formData.additional_notes.length;
            }

            // Step 10: Restore contact details
            if (formData.first_name) document.getElementById('firstName').value = formData.first_name;
            if (formData.last_name) document.getElementById('lastName').value = formData.last_name;
            if (formData.email) document.getElementById('email').value = formData.email;
            if (formData.phone) document.getElementById('phone').value = formData.phone;

            formData.contact_preferences.forEach(pref => {
                if (pref === 'Email') document.getElementById('prefEmail').checked = true;
                if (pref === 'Text') document.getElementById('prefText').checked = true;
                if (pref === 'Phone Call') document.getElementById('prefPhone').checked = true;
            });
            validateStep10();
        }
    </script>

    <!-- Footer -->
    <footer style="background: #0F172A; padding: 40px 0; margin-top: 80px;">
        <div class="container">
            <div style="text-align: center;">
                <!-- Logo -->
                <div style="margin-bottom: 20px;">
                    <svg width="100" height="40" viewBox="0 0 110 40">
                        <circle cx="20" cy="20" r="6" fill="#0EA5E9" />
                        <path d="M 38 14 L 45 20 L 38 26" fill="none" stroke="#0EA5E9" stroke-width="3"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <text x="58" y="27" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto"
                            font-size="20" font-weight="600" fill="white">carbi</text>
                    </svg>
                </div>
                <!-- Contact line -->
                <p style="color: rgba(255,255,255,0.9); font-size: 1em; margin: 0 0 10px 0;">
                    email <a href="mailto:hello@carbi.co"
                        style="color: #0EA5E9; text-decoration: none;">hello@carbi.co</a>
                </p>
                </p>
                <!-- Copyright -->
                <p style="color: rgba(255,255,255,0.7); font-size: 0.95em; margin: 0;">
                    ¬© 2025 Carbi. Making first cars happen. | <a href="/privacy.html"
                        style="color: rgba(255,255,255,0.7); text-decoration: none;">Privacy Policy</a>
                </p>
            </div>
        </div>
    </footer>
</body>

</html>